<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô AUTODIDACTIC</title>
<style>
/* ===== General Theme ===== */
body {
  font-family: 'Prompt', sans-serif;
  background: linear-gradient(to bottom, #fff 0%, #fee 100%);
  color: #c00;
  margin: 0;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ===== Header ===== */
header {
  background: #c00;
  color: #fff;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 20px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.logo-container {
  display: flex;
  align-items: center;
  background: rgba(255,255,255,0.9);
  padding: 6px 10px;
  border-radius: 8px;
}
.logo-container img { width: 50px; height: auto; }
header h1 {
  flex: 1;
  text-align: center;
  font-size: 20px;
  font-weight: bold;
}
header nav a {
  color: #fff;
  background: rgba(0,0,0,0.2);
  padding: 8px 14px;
  border-radius: 8px;
  font-weight: 600;
  text-decoration: none;
  transition: 0.3s;
}
header nav a:hover { background: rgba(255,255,255,0.3); }

/* ===== Layout ===== */
main {
  flex: 1;
  display: flex;
  flex-direction: row;
  justify-content: center;
  gap: 20px;
  flex-wrap: wrap;
  padding: 20px;
  box-sizing: border-box;
}

/* ===== Form Panel ===== */
form {
  flex: 1 1 340px;
  max-width: 520px;
  background: #fff;
  border: 2px solid #c00;
  border-radius: 15px;
  padding: 25px;
  box-sizing: border-box;
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
  transition: transform 0.3s;
}
form:hover { transform: translateY(-3px); }
h2 { text-align: center; color: #c00; margin-bottom: 20px; }

/* ===== Inputs ===== */
.input-line {
  width: 100%;
  padding: 10px 8px;
  margin: 12px 0;
  border: 2px solid #c00;
  border-radius: 8px;
  outline: none;
  font-size: 15px;
  color: rgb(0, 0, 0);
  background: #fff;
  transition: 0.3s;
  box-sizing: border-box;
  cursor: text;
}
.input-line:focus { border-color: #a00; box-shadow: 0 0 6px rgba(204,0,0,0.3); }
.input-line[readonly] { cursor: pointer; background: #fff; }
textarea.input-line { height: 90px; resize: none; cursor: text; }

/* ===== Thai Calendar Popup ===== */
.calendar-popup {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border: 3px solid #c00;
  border-radius: 15px;
  padding: 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  z-index: 1000;
  min-width: 320px;
}
.calendar-popup.active { display: block; }
.calendar-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 999;
}
.calendar-overlay.active { display: block; }
.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}
.calendar-header button {
  width: auto;
  padding: 5px 15px;
  margin: 0;
  font-size: 18px;
}
.calendar-header h3 {
  margin: 0;
  color: #c00;
  font-size: 18px;
}
.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 5px;
  margin-top: 10px;
}
.calendar-day {
  padding: 10px;
  text-align: center;
  border: 1px solid #ddd;
  border-radius: 5px;
  cursor: pointer;
  transition: 0.2s;
}
.calendar-day:hover {
  background: #fee;
  border-color: #c00;
}
.calendar-day.selected {
  background: #c00;
  color: white;
  font-weight: bold;
}
.calendar-day.disabled {
  color: #ccc;
  cursor: not-allowed;
}
.calendar-day.disabled:hover {
  background: white;
  border-color: #ddd;
}
.calendar-weekday {
  font-weight: bold;
  color: #c00;
  text-align: center;
  padding: 5px;
}

/* ===== Buttons ===== */
button {
  width: 100%;
  padding: 12px;
  margin-top: 15px;
  border-radius: 8px;
  background: #c00;
  color: #fff;
  font-weight: bold;
  border: none;
  cursor: pointer;
  font-size: 16px;
  transition: 0.3s;
}
button:hover { background: #a00; transform: scale(1.03); }

a.btn-back {
  display: inline-block;
  margin-top: 10px;
  text-align: center;
  background: #888;
  color: #fff;
  padding: 10px 18px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  transition: 0.3s;
}
a.btn-back:hover { background: #555; }

/* ===== Dropdown ===== */
.dropdown {
  position: relative;
  width: 100%;
  margin-bottom: 12px;
}
.dropdown-btn {
  width: 100%;
  padding: 8px 10px;
  border: 2px solid #c00;
  border-radius: 8px;
  background: #fff;
  color: rgb(0, 0, 0);
  font-size: 15px;
  text-align: left;
  cursor: pointer;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  min-height: 38px;
  align-items: center;
}
.dropdown-content {
  display: none;
  position: absolute;
  background-color: #fff;
  border: 1px solid #c00;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  z-index: 10;
  width: 100%;
  max-height: 200px;
  overflow-y: auto;
  padding: 5px;
}
.dropdown-content label {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 10px;
  cursor: pointer;
}
.dropdown-content label:hover { background: #fee; }
.selected-name {
  background: #c00;
  color: #fff;
  border-radius: 12px;
  padding: 2px 6px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 13px;
}

/* ===== Side Panel ===== */
#sidePanel {
  flex: 1 1 260px;
  min-width: 260px;
  border: 2px solid #c00;
  border-radius: 15px;
  padding: 20px;
  background: #fff;
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
  overflow-y: auto;
  max-height: 85vh;
}
#sidePanel h3 { text-align: center; color: #c00; }
.event-item {
  border: 1px solid #c00;
  border-radius: 8px;
  padding: 10px;
  margin-bottom: 12px;
  background: #fff;
}
.event-actions button {
  width: auto;
  padding: 6px 10px;
  margin-right: 5px;
  font-size: 13px;
}
.print-btn { background: #444; }
.print-btn:hover { background: #000; }

/* ===== Footer ===== */
footer {
  background: #c00;
  color: #fff;
  text-align: center;
  padding: 12px;
  font-size: 14px;
  box-shadow: 0 -4px 8px rgba(0,0,0,0.05);
}

/* ===== Responsive ===== */
@media(max-width:900px){
  main { flex-direction: column; align-items: center; }
  form, #sidePanel { width: 95%; max-width: 520px; }
  header h1 { font-size: 18px; }
}
</style>
</head>

<body>

<header>
  <div class="logo-container">
    <img src="ad_logo-Photoroom.png" alt="Logo">
  </div>
  <h1>üìã ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô AUTODIDACTIC</h1>
  <nav><a href="calendar_admin.html">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</a></nav>
</header>

<main>
  <!-- ========== FORM ========== -->
  <form id="eventForm">
    <h2 id="formTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
    <input type="hidden" id="eventId">

    <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô:</label>
    <input type="text" id="jobNumber" class="input-line" placeholder="‡πÄ‡∏ä‡πà‡∏ô JOB-001 (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">

    <label>‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô:</label>
    <div class="dropdown">
      <button type="button" class="dropdown-btn" id="assignedByBtn">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠</button>
      <div class="dropdown-content" id="assignedByList"></div>
    </div>

    <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô (‡∏û.‡∏®.):</label>
    <input type="text" id="orderDate" class="input-line" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" readonly required>

    <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏° (‡∏û.‡∏®.):</label>
    <input type="text" id="start" class="input-line" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" readonly required>

    <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡∏û.‡∏®.):</label>
    <input type="text" id="end" class="input-line" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" readonly required>

    <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</label>
    <input type="text" id="location" class="input-line" required>

    <label>‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏á‡∏≤‡∏ô:</label>
    <div id="jobTypeGroup" class="checkbox-group">
      <label><input type="checkbox" value="‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö"> ‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</label>
      <label><input type="checkbox" value="‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°"> ‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°</label>
      <label><input type="checkbox" value="‡∏≠‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"> ‡∏≠‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
      <label><input type="checkbox" value="‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ/‡∏ã‡πà‡∏≠‡∏°"> ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ/‡∏ã‡πà‡∏≠‡∏°</label>
      <label><input type="checkbox" value="Visit"> Visit</label>
      <label><input type="checkbox" id="otherJobTypeCheck" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ"> ‡∏≠‡∏∑‡πà‡∏ô‡πÜ:
        <input type="text" id="otherJobTypeText" placeholder="‡∏£‡∏∞‡∏ö‡∏∏..." style="width:120px;">
      </label>
    </div>

    <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô:</label>
    <textarea id="details" class="input-line" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô..." required></textarea>

    <label>‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</label>
    <input type="text" id="contactPerson" class="input-line" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠" required>

    <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</label>
    <input type="tel" id="phoneNumber" class="input-line" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0812345678" required>

    <button type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <a href="calendar_admin.html" class="btn-back">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</a>
  </form>

  <!-- ========== EVENT LIST ========== -->
  <div id="sidePanel">
    <h3>üßæ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h3>
    <div id="eventList"></div>
  </div>
</main>

<!-- ========== CALENDAR POPUP ========== -->
<div class="calendar-overlay" id="calendarOverlay"></div>
<div class="calendar-popup" id="calendarPopup">
  <div class="calendar-header">
    <button type="button" id="prevMonth">‚óÄ</button>
    <h3 id="calendarTitle"></h3>
    <button type="button" id="nextMonth">‚ñ∂</button>
  </div>
  <div class="calendar-grid" id="calendarWeekdays"></div>
  <div class="calendar-grid" id="calendarDays"></div>
  <button type="button" id="closeCalendar" style="margin-top: 15px;">‡∏õ‡∏¥‡∏î</button>
</div>

<footer>¬© 2025 AUTODIDACTIC SYSTEM. ‡∏™‡∏á‡∏ß‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</footer>

<!-- ========== SCRIPT SECTION ========== -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, doc, getDocs, addDoc, deleteDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAXayBBLVSohNCIsnlWRq6rD0BUbW70MGk",
  authDomain: "events-666d6.firebaseapp.com",
  projectId: "events-666d6",
  storageBucket: "events-666d6.appspot.com",
  messagingSenderId: "589078390914",
  appId: "1:589078390914:web:480ce96137ffac835aac9b",
  measurementId: "G-97GD75S814"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== Thai Calendar System =====
const thaiMonths = [
  "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
  "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"
];
const thaiWeekdays = ["‡∏≠‡∏≤", "‡∏à", "‡∏≠", "‡∏û", "‡∏û‡∏§", "‡∏®", "‡∏™"];

let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let selectedInput = null;
let selectedDate = null;

function showCalendar(inputId) {
  selectedInput = document.getElementById(inputId);
  const overlay = document.getElementById("calendarOverlay");
  const popup = document.getElementById("calendarPopup");
  
  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πâ‡∏ô
  if (selectedInput.dataset.isoDate) {
    const date = new Date(selectedInput.dataset.isoDate);
    currentMonth = date.getMonth();
    currentYear = date.getFullYear();
  } else {
    const today = new Date();
    currentMonth = today.getMonth();
    currentYear = today.getFullYear();
  }
  
  renderCalendar();
  overlay.classList.add("active");
  popup.classList.add("active");
}

function hideCalendar() {
  document.getElementById("calendarOverlay").classList.remove("active");
  document.getElementById("calendarPopup").classList.remove("active");
}

function renderCalendar() {
  const title = document.getElementById("calendarTitle");
  const daysContainer = document.getElementById("calendarDays");
  const weekdaysContainer = document.getElementById("calendarWeekdays");
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏µ ‡∏û.‡∏®.
  const beYear = currentYear + 543;
  title.textContent = `${thaiMonths[currentMonth]} ${beYear}`;
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
  weekdaysContainer.innerHTML = thaiWeekdays.map(day => 
    `<div class="calendar-weekday">${day}</div>`
  ).join("");
  
  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  
  daysContainer.innerHTML = "";
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1
  for (let i = 0; i < firstDay; i++) {
    const emptyDiv = document.createElement("div");
    emptyDiv.className = "calendar-day disabled";
    daysContainer.appendChild(emptyDiv);
  }
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
  for (let day = 1; day <= daysInMonth; day++) {
    const dayDiv = document.createElement("div");
    dayDiv.className = "calendar-day";
    dayDiv.textContent = day;
    
    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (selectedInput && selectedInput.dataset.isoDate === dateStr) {
      dayDiv.classList.add("selected");
    }
    
    dayDiv.addEventListener("click", () => selectDate(day));
    daysContainer.appendChild(dayDiv);
  }
}

function selectDate(day) {
  if (!selectedInput) return;
  
  const selectedDateObj = new Date(currentYear, currentMonth, day);
  const isoDate = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö DD/MM/YYYY (‡∏û.‡∏®.)
  const beYear = currentYear + 543;
  const displayDate = `${String(day).padStart(2, '0')}/${String(currentMonth + 1).padStart(2, '0')}/${beYear}`;
  
  selectedInput.value = displayDate;
  selectedInput.dataset.isoDate = isoDate;
  
  hideCalendar();
}

document.getElementById("prevMonth").addEventListener("click", () => {
  currentMonth--;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  }
  renderCalendar();
});

document.getElementById("nextMonth").addEventListener("click", () => {
  currentMonth++;
  if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  renderCalendar();
});

document.getElementById("closeCalendar").addEventListener("click", hideCalendar);
document.getElementById("calendarOverlay").addEventListener("click", hideCalendar);

// ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ input ‡∏Å‡∏±‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
document.getElementById("orderDate").addEventListener("click", () => showCalendar("orderDate"));
document.getElementById("start").addEventListener("click", () => showCalendar("start"));
document.getElementById("end").addEventListener("click", () => showCalendar("end"));

// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡πâ orderDate
const today = new Date();
const todayISO = today.toISOString().split("T")[0];
const todayBE = `${today.getDate()} ${thaiMonths[today.getMonth()]} ${today.getFullYear() + 543}`;
document.getElementById("orderDate").value = todayBE;
document.getElementById("orderDate").dataset.isoDate = todayISO;

const eventList = document.getElementById("eventList");
const assignedByBtn = document.getElementById("assignedByBtn");
const assignedByList = document.getElementById("assignedByList");

function formatDateThai(dateStr) {
  if (!dateStr) return "-";
  const [year, month, day] = dateStr.split("-");
  const thaiYear = parseInt(year) + 543;
  return `${day}/${month}/${thaiYear}`;
}

async function loadEvents() {
  eventList.innerHTML = "";
  const snap = await getDocs(collection(db, "events"));
  snap.forEach(docSnap => {
    const data = docSnap.data();
    const isFinished = data.status === "‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" || data.status === "‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
    
    // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢
    if (isFinished) return;
    
    const div = document.createElement("div");
    div.className = "event-item";
    const isApproved = data.status === "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥";

    let buttonsHTML = "";
    if (isApproved) {
      buttonsHTML = `
        <div class="event-actions">
          <button class="print-btn" onclick="printEvent('${docSnap.id}')">üñ® ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
        </div>`;
    } else if (!isFinished) {
      buttonsHTML = `
        <div class="event-actions">
          <button class="edit-btn" onclick="editEvent('${docSnap.id}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="print-btn" onclick="printEvent('${docSnap.id}')">üñ® ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
          <button class="delete-btn" onclick="deleteEvent('${docSnap.id}')">üóë ‡∏•‡∏ö</button>
        </div>`;
    }

    div.innerHTML = `
      <strong>${data.jobNumber || "-"}</strong><br>
      üìç ${data.location}<br>
      üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô: ${formatDateThai(data.orderDate)}<br>
      üë§ ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ${data.contactPerson || "-"}<br>
      üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: ${data.phoneNumber || "-"}<br>
      üß∞ ${(data.jobTypes || []).join(", ")}<br>
      üìÖ ${formatDateThai(data.start)} ‚Üí ${formatDateThai(data.end)}<br>
      üßë‚Äçüíº ${(data.assigners || []).join(", ")}<br>
      üìå ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <strong>${data.status || "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"}</strong><br>
      ${buttonsHTML}`;
      
    eventList.appendChild(div);
  });
}

window.deleteEvent = async id => {
  if (confirm("‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
    await deleteDoc(doc(db, "events", id));
    await loadEvents();
  }
}

window.editEvent = async id => {
  const docRef = doc(db, "events", id);
  const docSnap = await getDoc(docRef);
  const data = docSnap.data();
  if (!data) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
  if (data.status === "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥") return alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏î‡πâ");

  await loadNames();

  document.getElementById("eventId").value = id;
  document.getElementById("jobNumber").value = data.jobNumber || "";
  document.getElementById("location").value = data.location;
  document.getElementById("details").value = data.details;
  document.getElementById("contactPerson").value = data.contactPerson || "";
  document.getElementById("phoneNumber").value = data.phoneNumber || "";

  // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢
  if (data.orderDate) {
    const date = new Date(data.orderDate);
    document.getElementById("orderDate").value = `${date.getDate()} ${thaiMonths[date.getMonth()]} ${date.getFullYear() + 543}`;
    document.getElementById("orderDate").dataset.isoDate = data.orderDate;
  }
  if (data.start) {
    const date = new Date(data.start);
    document.getElementById("start").value = `${date.getDate()} ${thaiMonths[date.getMonth()]} ${date.getFullYear() + 543}`;
    document.getElementById("start").dataset.isoDate = data.start;
  }
  if (data.end) {
    const date = new Date(data.end);
    document.getElementById("end").value = `${date.getDate()} ${thaiMonths[date.getMonth()]} ${date.getFullYear() + 543}`;
    document.getElementById("end").dataset.isoDate = data.end;
  }

  document.querySelectorAll("#jobTypeGroup input[type=checkbox]").forEach(cb => cb.checked = false);
  document.getElementById("otherJobTypeText").value = "";

  if (data.jobTypes) {
    document.querySelectorAll("#jobTypeGroup input[type=checkbox]").forEach(cb => {
      if (data.jobTypes.includes(cb.value)) cb.checked = true;
    });
    const other = data.jobTypes.find(t => !["‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö","‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°","‡∏≠‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤","‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ/‡∏ã‡πà‡∏≠‡∏°","Visit","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"].includes(t));
    if (other) {
      document.getElementById("otherJobTypeCheck").checked = true;
      document.getElementById("otherJobTypeText").value = other;
    }
  }

  assignedByList.querySelectorAll("input[type=checkbox]").forEach(cb => {
    if ((data.assigners || []).includes(cb.value)) {
      cb.checked = true;
      cb.disabled = false;
      cb.parentElement.style.opacity = 1;
    }
  });

  updateDropdownButton(assignedByList, assignedByBtn);
  document.getElementById("formTitle").innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô";
};

document.getElementById("eventForm").addEventListener("submit", async e => {
  e.preventDefault();
  const id = document.getElementById("eventId").value;
  const jobNumber = document.getElementById("jobNumber").value.trim();
  const location = document.getElementById("location").value.trim();
  const details = document.getElementById("details").value.trim();
  const orderDate = document.getElementById("orderDate").dataset.isoDate || "";
  const start = document.getElementById("start").dataset.isoDate || "";
  const end = document.getElementById("end").dataset.isoDate || "";
  const contactPerson = document.getElementById("contactPerson").value.trim();
  const phoneNumber = document.getElementById("phoneNumber").value.trim();
  const assigners = Array.from(assignedByList.querySelectorAll("input[type=checkbox]:checked")).map(cb => cb.value);

  if (!orderDate || !start || !end) {
    return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
  }

  let jobTypes = Array.from(document.querySelectorAll("#jobTypeGroup input[type=checkbox]:checked")).map(cb => cb.value);
  if (document.getElementById("otherJobTypeCheck").checked) {
    const otherText = document.getElementById("otherJobTypeText").value.trim();
    if (otherText) jobTypes = jobTypes.filter(t => "‡∏≠‡∏∑‡πà‡∏ô‡πÜ" !== t).concat(otherText);
  }

  try {
    if (id) {
      const docRef = doc(db, "events", id);
      await updateDoc(docRef, { jobNumber, location, details, orderDate, start, end, assigners, jobTypes, contactPerson, phoneNumber });
      alert("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      await clearFormAfterSave();
    } else {
      await addDoc(collection(db, "events"), {
        jobNumber, location, details, orderDate, start, end, assigners, jobTypes, contactPerson, phoneNumber,
        status: "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"
      });
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      await clearFormAfterSave();
    }

    loadEvents();
  } catch (err) {
    console.error(err);
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
  }
});


function updateDropdownButton(listEl, btnEl){
  const selected = Array.from(listEl.querySelectorAll("input[type=checkbox]:checked")).map(cb=>cb.value);
  btnEl.innerHTML = selected.map(n=>`<span class="selected-name">${n}</span>`).join(" ") || "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠";
}

assignedByBtn.addEventListener("click", (e)=> {
  e.stopPropagation();
  assignedByList.style.display = assignedByList.style.display==="block"?"none":"block";
});

assignedByList.addEventListener("change", () => {
  updateDropdownButton(assignedByList, assignedByBtn);
  assignedByList.style.display = "none";
});

document.addEventListener("click", (e) => {
  if (!e.target.closest(".dropdown")) {
    assignedByList.style.display = "none";
  }
});

async function loadNames() {
  assignedByList.innerHTML = "";

  const assignersSnap = await getDocs(collection(db, "assigners"));
  assignersSnap.forEach(docSnap => {
    const name = docSnap.data().name;
    assignedByList.innerHTML += `
      <label>
        <input type="checkbox" value="${name}"> ${name}
      </label>`;
  });

  updateDropdownButton(assignedByList, assignedByBtn);
}

loadEvents();
loadNames();

document.querySelectorAll('#jobTypeGroup input[type="checkbox"]').forEach(cb => {
  cb.addEventListener('change', () => {
    const selected = Array.from(document.querySelectorAll('#jobTypeGroup input[type="checkbox"]:checked'))
      .map(cb => cb.value);

    const otherText = document.getElementById("otherJobTypeText").value.trim();
    if (document.getElementById("otherJobTypeCheck").checked && otherText) {
      selected.push(otherText);
    }

    localStorage.setItem('savedJobTypes', JSON.stringify(selected));
  });
});

document.getElementById("otherJobTypeText").addEventListener("input", () => {
  const otherCheck = document.getElementById("otherJobTypeCheck");
  if (otherCheck.checked) {
    const selected = Array.from(document.querySelectorAll('#jobTypeGroup input[type="checkbox"]:checked'))
      .map(cb => cb.value);

    const otherText = document.getElementById("otherJobTypeText").value.trim();
    if (otherText) selected.push(otherText);

    localStorage.setItem('savedJobTypes', JSON.stringify(selected));
  }
});

window.addEventListener('DOMContentLoaded', () => {
  const saved = JSON.parse(localStorage.getItem('savedJobTypes') || '[]');
  if (saved.length > 0) {
    document.querySelectorAll('#jobTypeGroup input[type="checkbox"]').forEach(cb => {
      if (saved.includes(cb.value)) cb.checked = true;
    });
    const knownTypes = ["‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö", "‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°", "‡∏≠‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ/‡∏ã‡πà‡∏≠‡∏°", "Visit", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"];
    const other = saved.find(v => !knownTypes.includes(v));
    if (other) {
      document.getElementById("otherJobTypeCheck").checked = true;
      document.getElementById("otherJobTypeText").value = other;
    }
  }
});

function saveFormToLocalStorage() {
  const formData = {
    jobNumber: document.getElementById("jobNumber").value.trim(),
    location: document.getElementById("location").value.trim(),
    details: document.getElementById("details").value.trim(),
    orderDate: document.getElementById("orderDate").value,
    start: document.getElementById("start").value,
    end: document.getElementById("end").value,
    contactPerson: document.getElementById("contactPerson").value.trim(),
    phoneNumber: document.getElementById("phoneNumber").value.trim(),
    assigners: Array.from(assignedByList.querySelectorAll("input[type=checkbox]:checked")).map(cb => cb.value),
    jobTypes: Array.from(document.querySelectorAll('#jobTypeGroup input[type="checkbox"]:checked')).map(cb => cb.value),
    otherJobTypeText: document.getElementById("otherJobTypeText").value.trim()
  };
  localStorage.setItem("eventFormData", JSON.stringify(formData));
}

function loadFormFromLocalStorage() {
  const saved = JSON.parse(localStorage.getItem("eventFormData") || "{}");
  if (!saved) return;

  document.getElementById("jobNumber").value = saved.jobNumber || "";
  document.getElementById("location").value = saved.location || "";
  document.getElementById("details").value = saved.details || "";
  document.getElementById("orderDate").value = saved.orderDate || "";
  document.getElementById("start").value = saved.start || "";
  document.getElementById("end").value = saved.end || "";
  document.getElementById("contactPerson").value = saved.contactPerson || "";
  document.getElementById("phoneNumber").value = saved.phoneNumber || "";

  document.querySelectorAll('#jobTypeGroup input[type="checkbox"]').forEach(cb => {
    cb.checked = saved.jobTypes?.includes(cb.value) || false;
  });
  if (saved.otherJobTypeText) {
    document.getElementById("otherJobTypeCheck").checked = true;
    document.getElementById("otherJobTypeText").value = saved.otherJobTypeText;
  }

  assignedByList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.checked = saved.assigners?.includes(cb.value) || false;
  });
  updateDropdownButton(assignedByList, assignedByBtn);
}

document.querySelectorAll('#eventForm input, #eventForm textarea').forEach(el => {
  el.addEventListener('input', saveFormToLocalStorage);
});
document.querySelectorAll('#eventForm input[type="checkbox"]').forEach(cb => {
  cb.addEventListener('change', saveFormToLocalStorage);
});

window.addEventListener('DOMContentLoaded', loadFormFromLocalStorage);

async function clearFormAfterSave() {
  localStorage.removeItem("eventFormData");
  localStorage.removeItem("savedJobTypes");
  localStorage.removeItem("selectedAssigners");

  const form = document.getElementById("eventForm");
  form.reset();

  document.getElementById("eventId").value = "";
  document.getElementById("otherJobTypeText").value = "";

  document.querySelectorAll("#jobTypeGroup input[type=checkbox]").forEach(cb => cb.checked = false);
  document.querySelectorAll(".dropdown-content input[type=checkbox]").forEach(cb => cb.checked = false);

  document.getElementById("assignedByBtn").innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠";
  
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("orderDate").value = today;
}

function saveNamesSelection() {
  const selectedAssigners = Array.from(assignedByList.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
  localStorage.setItem("selectedAssigners", JSON.stringify(selectedAssigners));
}

function loadNamesSelection() {
  const savedAssigners = JSON.parse(localStorage.getItem("selectedAssigners") || "[]");

  assignedByList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.checked = savedAssigners.includes(cb.value);
  });

  updateDropdownButton(assignedByList, assignedByBtn);
}

assignedByList.addEventListener('change', () => {
  saveNamesSelection();
  updateDropdownButton(assignedByList, assignedByBtn);
});

window.addEventListener('DOMContentLoaded', () => {
  setTimeout(loadNamesSelection, 1000);
});

function goToReportPage(page) {
  const jobNumber = document.getElementById("jobNumber").value.trim() || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
  const start = document.getElementById("start").value;
  const end = document.getElementById("end").value;

  if (!start || !end) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }

  const url = `${page}?job=${encodeURIComponent(jobNumber)}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
  window.location.href = url;
}

document.querySelector('input[value="‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö"]').addEventListener('change', (e) => {
  if (e.target.checked) goToReportPage("report_send.html");
});
document.querySelector('input[value="‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°"]').addEventListener('change', (e) => {
  if (e.target.checked) goToReportPage("seereport4.html");
});
document.querySelector('input[value="‡∏≠‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"]').addEventListener('change', (e) => {
  if (e.target.checked) goToReportPage("seereport2.html");
});
document.querySelector('input[value="‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ/‡∏ã‡πà‡∏≠‡∏°"]').addEventListener('change', (e) => {
  if (e.target.checked) goToReportPage("seereport3.html");
});


window.printEvent = async (id) => {
  const docRef = doc(db, "events", id);
  const docSnap = await getDoc(docRef);

  if (!docSnap.exists()) {
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô");
    return;
  }

  const jobNumber = docSnap.data().jobNumber || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";

  const url = new URL("reportS.html", window.location.href);
  url.searchParams.set("job", jobNumber);

  window.open(url, "_blank");
};


</script>
</body>
</html>